# 250214 upload

import streamlit as st
from PIL import Image
from io import BytesIO
from PIL import Image
import base64
import os
import json
from openai import OpenAI
import pandas as pd
from io import StringIO
import pdfplumber
import openai
from openai import OpenAI
from langchain_community.document_loaders import PyMuPDFLoader
import base64
import fitz
import time
from datetime import datetime, timedelta

os.environ["OPENAI_API_KEY"] = "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"
st.set_page_config(layout="wide", page_title="Voronoi Label StudioğŸ§‘â€ğŸ’»")

st.write("## Clinical dataset LabelMate")
st.markdown("Please upload your files (the **full paper** and **table images**) first, and review the table generated by GPT. There may be **errors**, so please check carefully.")
st.sidebar.write("## Upload Your Files :gear:")

tab1, tab2 = st.tabs(["Efficacy", "Toxicity"])
paper_pdf_upload = st.sidebar.file_uploader("Full Paper PDF format", type=["PDF"]) # 1ê°œê¹Œì§€ í—ˆìš©
paper_efficacy_upload = st.sidebar.file_uploader("Efficacy Table PNG format", type=["PNG"], accept_multiple_files=True) # 3ê°œê¹Œì§€ í—ˆìš©
paper_toxicity_upload = st.sidebar.file_uploader("Toxicity Table PNG format", type=["PNG"], accept_multiple_files=True) # 3ê°œê¹Œì§€ í—ˆìš©
paper_dose_upload = st.sidebar.file_uploader("Dose info Table PNG format", type=["PNG"], accept_multiple_files=True) # 3ê°œê¹Œì§€ í—ˆìš©

def check_column_headers(df1, df2):
    return list(df1.columns) == list(df2.columns)

def encode_image(image_bytes):
    return base64.b64encode(image_bytes).decode('utf-8')

def eff_pdf_to_text(upload):

    if upload is not None:
            start = time.time()
            file_bytes = upload.read()
            pdf_document = fitz.open(stream=file_bytes, filetype="pdf")
            full_text = ""
            for page_num in range(pdf_document.page_count):
                page = pdf_document.load_page(page_num)
                full_text += page.get_text()

            client = OpenAI()
            response_text = client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {
                        "role": "user",
                        "content": [
                            {
                                "type": "text",
                                "text": f"ì œê³µí•œ í…ìŠ¤íŠ¸ ìë£Œì—ì„œ Abstract ë¬¸ë‹¨ ë‚´ìš©ê³¼ efficacyì— ëŒ€í•´ ì„¤ëª…í•˜ê³  ìˆëŠ” ëª¨ë“  ë¬¸ë‹¨ë“¤ì„ ê°€ì ¸ì™€ì„œ ì¶œë ¥í•´ì¤˜. í…ìŠ¤íŠ¸ ìë£Œ:{full_text}.",
                            },
                        ],
                    }
                ],
            )
            end = time.time()
            elapsed_time = end - start
            print(f"eff_pdf_to_text()ì— ê±¸ë¦° ì‹œê°„: {elapsed_time} sec")

            related_text_input = response_text.choices[0].message.content
            print("ìµœì¢… ì‚¬ìš©í•  ë…¼ë¬¸ ë³¸ë¬¸ ë‚´ìš©:\n", related_text_input)
            return related_text_input

def efficacy_table_image(upload):

    if upload:
        start = time.time()
        base64_image = encode_image(upload.read())
        client = OpenAI()
        response_replic = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": """

                            **í•´ì•¼í•˜ëŠ” ì¼ **
                            ì œê³µëœ ì´ë¯¸ì§€ì— ìˆëŠ” í‘œë¥¼ í…ìŠ¤íŠ¸ í‘œë¡œ ë°”ê¿”ì„œ csv formatìœ¼ë¡œ ë°˜í™˜í•´ì¤˜. ì¶”ê°€ ì„¤ëª…ì€ ì£¼ì§€ ë§ê³  CSV í¬ë©§ í‘œë§Œ ë°˜í™˜í•´.
                            ì´ë•Œ, í‘œì— í•¨ê»˜ ìˆëŠ” caption ê¸€ì„ csv format ë§¨ ë°‘ì— í–‰ì— í•¨ê»˜ ë°˜í™˜í•´ì¤˜. í–‰ ëˆ„ë½ ì—†ì´ ëª¨ë“  ì •ë³´ê°€ ë‹´ê²¨ì•¼í•´. "ì •ë³´ ëˆ„ë½í•˜ì§€ë§ˆ"

                            **ê³ ë ¤í•  ê²ƒ**
                            í–‰/ì—´ì„ ì˜ êµ¬ë¶„í•˜ê³ , ì´ë•Œ **ë„ì–´ì“°ê¸°ë‚˜ ë³¼ë“œì²´ ë“±ì˜ íŠ¹ì§•**ì„ ë³´ê³ , **ìƒìœ„ ê°œë… í•˜ìœ„ ê°œë…** ê´€ê³„ë¥¼ ëª¨ë‘ íŒŒì•…í•˜ì—¬ ìƒìœ„í•­ëª©(ì˜ˆë¥¼ ë“¤ì–´ Objective response rate)-í•˜ìœ„í•­ëª©(at 8 mo)ìœ¼ë¡œ **í•©ì³ì„œ í–‰**ìœ¼ë¡œ ë§Œë“¤ì–´ì¤˜.
                            ìˆ˜ì¹˜ê°€ **ì •í™•**í•˜ê²Œ ê¸°ì…ë˜ì–´ì•¼í•´. ëª¨ë¥´ê² ìœ¼ë©´ ë¹ˆì¹¸ìœ¼ë¡œ ë‚¨ê²¨ë‘ê³ , í™•ì‹¤í•œ ê²ƒë§Œ ê¸°ì…í•´. ê°€ë” ìœ— í–‰ê³¼ ì•„ë˜ í–‰ì˜ ìˆ˜ì¹˜ë¥¼ ë°”ê¿”ì„œ ì ê±°ë‚˜ ìƒˆë¡œ ë§Œë“œëŠ” ê²½ìš°ê°€ ìˆë”ë¼. í—·ê°ˆë¦¬ë©´ ë¹ˆì¹¸ìœ¼ë¡œ ëƒ…ë‘¬.

                            """,
                        },
                        {
                            "type": "image_url",
                            "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"},
                        },
                    ],
                }
            ],
        )

        response_replic = response_replic.choices[0].message.content

        rows111 = response_replic.split("\n")
        data111 = [row.split(",") for row in rows111]
        df111 = pd.DataFrame(data111)
        df111 = df111.applymap(lambda x: x.replace('"', '') if isinstance(x, str) else x)

        end = time.time()
        elapsed_time = end - start
        print(f"efficacy_table_image()ì— ê±¸ë¦° ì‹œê°„: {elapsed_time} sec \n\n")

        related_table_input = df111.to_csv(index=False)

        rows111 = related_table_input.split("\n")
        data111 = [row.split(",") for row in rows111]
        df111 = pd.DataFrame(data111)
        df = df111.applymap(lambda x: x.replace('"', '') if isinstance(x, str) else x)

        start_index = df[df.iloc[:, 0].str.contains('```', na=False)].index[0]
        end_index = df.iloc[start_index+1:][df.iloc[start_index+1:, 0].str.contains('```', na=False)].index[0]
        related_table_input = df.iloc[start_index+2:end_index]
        
        print("\n efficacy_table_image() í‘œ ë³µì œ ì¶œë ¥:",related_table_input)
    else:
            related_table_input = None
    return related_table_input

def efficacy_table(related_table_input, related_text_input):

    start = time.time()
    client = OpenAI()
    response_our_excel = client.chat.completions.create(
    model="gpt-4o",
    messages=[
        {
            "role": "user",
            "content": f"""
            You have received both a table image and its corresponding CSV input. 
            Please verify if the CSV input correctly matches the table image. 
            If discrepancies are found, correct them and update the CSV input to reflect the accurate table. 
            Use the corrected CSV to construct a new dataframe as per the output data structure instructions below.

            ### **Input Data Rules:**
            - The input is:
            ```
              {related_table_input}
            ```
            - **Do NOT modify, rephrase, summarize, omit, or alter any text, numbers, units, expressions, or symbols in any way.**
            - **Preserve full content, even if the text is long or contains commas, parentheses, or special characters.**
            - **Extract data exactly as it appears in the original table, maintaining full text integrity.**
            - Extract the correct values **by matching the row and column structure**, ensuring all relevant cell content is retained.

            ### **Output Data Structure:**
            The output should be a new table with the following columns:
            ["treat_group", "sub_group", "no. patients", "category", "value(#)", "value(%)", "range_type", "range_low", "range_high"]
            Each column follows these strict rules:
            - **treat_group**: If data is divided by dosage units, extract only the dosage value here.
            - **sub_group**: Extracted from the column headers of the input table. If thereâ€™s dosage info, exclude it.
            - **no. patients**: Extract the total number of patients for each `sub_group`. Only the numeric value should be written (e.g., if total patients = 10, just write 10, not `N=10`).
            - **category**: Extracted from the row headers. This should include the full row header text exactly as written (e.g., `"Progression-free survivalâ€ , Median (95% CI) â€” mo"`, with all symbols and formatting). **Do not truncate or shorten this text.**
            - If a value represents a count (#) or percentage (%), categorize it as `value(#)` or `value(%)` accordingly. Ensure metrics like "mo" go into the `value(#)` column, and correctly identify percentages.
            - **Do NOT alter or remove units**. If a cell contains multiple values, keep them together as a single string.
            - **range_type**: Extract the confidence interval or range exactly as stated (e.g., `"95% CI"`).
            - **range_low** / **range_high**: Extract the exact minimum and maximum values from the range **without modification**.

            ### **Strict Output Rules:**
            - **Preserve all formatting, symbols, parentheses, spacing, commas, and special characters exactly as they appear in the input.**
            - **If a value includes a comma but was in a single cell in the original table, keep it together. Do not split it into multiple columns.**
            - Ensure **category** contains the full original row header text **without omission**. Do not truncate long text.
            - **Sometimes, data may be missing in output**. Ensure all data is included, check for any missing rows or entries.
            - Return the final structured data in pure CSV format, without additional text, explanations, or notes.
            """
        }
    ]
)


    print(response_our_excel)
    response_our_excel_data = response_our_excel.choices[0].message.content

    rows111 = response_our_excel_data.split("\n")
    data111 = [row.split(",") for row in rows111]
    df111 = pd.DataFrame(data111)
    df111 = df111.applymap(lambda x: x.replace('"', '') if isinstance(x, str) else x)

    header_idx = df111[df111[0] == 'treat_group'].index[0]
    df111.columns = df111.iloc[header_idx].values
    df_cleaned = df111.iloc[header_idx + 1:].reset_index(drop=True)
    end_idx = df_cleaned[df_cleaned.iloc[:, 0].str.contains('```', na=False)].index[0]
    efficacy_output = df_cleaned.iloc[:end_idx].reset_index(drop=True)

    end = time.time()
    elapsed_time = end - start
    print(f"efficacy_table()ì— ê±¸ë¦° ì‹œê°„: {elapsed_time} sec\n\n")

    efficacy_output = efficacy_output.sort_values(by=['treat_group', 'sub_group'], ascending=[True, True]).reset_index(drop=True)
    return efficacy_output

def efficacy_add_table(eff_table1, eff_table2):
    if eff_table1 is not None and eff_table2 is not None: 
        if check_column_headers(eff_table1, eff_table2):
            efficacy_output = pd.concat([eff_table1, eff_table2], axis=0, ignore_index=True)
            return efficacy_output

    elif eff_table1 is not None and eff_table2 is None: 
            efficacy_output = eff_table1
            return efficacy_output

    else:
        efficacy_output = None
        return None


## display setting... 
if paper_pdf_upload is None:
    st.markdown("ë…¼ë¬¸ PDF íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")

else:

    folder_name = paper_pdf_upload.name.split('.')[0]
    if not os.path.exists(folder_name):
        os.makedirs(folder_name)

    diaplay_replica_efficacy_excel_name = f"./{folder_name}/replica_efficacy_excel.xlsx"  
    diaplay_replica_efficacy_excel_name2 = f"./{folder_name}/replica_efficacy_excel2.xlsx"    
    diaplay_efficacy_excel_name = f"./{folder_name}/efficacy_excel.xlsx"
    diaplay_toxicity_excel_name = f"./{folder_name}/toxicity_excel.xlsx"

    with tab1:

        run_button, replica_button = tab1.columns([1,2])

        status_placeholder_left = st.empty()

        if run_button:
            st.session_state.clear()
            status_placeholder_left.markdown("Running Efficacy...")

            if paper_pdf_upload is None and len(paper_efficacy_upload) == 0:
                status_placeholder_left.markdown("Please upload your files!")

            else:
                status_placeholder_left.markdown("Reading the paper...")
                if paper_pdf_upload is not None:  
                    related_text_input = eff_pdf_to_text(upload=paper_pdf_upload)
                else:
                    related_text_input = None

                if len(paper_efficacy_upload) >= 2:
                    status_placeholder_left.markdown("Recognizing the table in the image...Efficacy Table 2ê°œì¼ ë•Œ")
                    related_table_input1 = efficacy_table_image(upload=paper_efficacy_upload[0])
                    related_table_input2 = efficacy_table_image(upload=paper_efficacy_upload[1])
                    related_table_input1.to_excel(diaplay_replica_efficacy_excel_name, index=False, engine='openpyxl')
                    related_table_input2.to_excel(diaplay_replica_efficacy_excel_name2, index=False, engine='openpyxl')

                    status_placeholder_left.markdown("Organizing the table...")
                    efficacy_table_output1 = efficacy_table(related_table_input1, related_text_input)
                    efficacy_table_output2 = efficacy_table(related_table_input2, related_text_input)
                    efficacy_table_output = efficacy_add_table(efficacy_table_output1, efficacy_table_output2)
                    efficacy_table_output.to_excel(diaplay_efficacy_excel_name, index=False, engine='openpyxl')
                    
                    status_placeholder_left.markdown(f"DataFrame successfully saved to '{diaplay_efficacy_excel_name}'")
                    status_placeholder_left.empty()

                elif len(paper_efficacy_upload) == 1:
                    status_placeholder_left.markdown("Recognizing the table in the image...Efficacy Table 1ê°œì¼ ë•Œ")
                    related_table_input = efficacy_table_image(upload=paper_efficacy_upload[0])
                    related_table_input.to_excel(diaplay_replica_efficacy_excel_name, index=False, engine='openpyxl')

                    # status_placeholder_left.markdown("Organizing the table...")
                    # efficacy_table_output = efficacy_table(paper_pdf_upload, related_table_input, related_text_input)
                    # efficacy_table_output.to_excel(diaplay_efficacy_excel_name, index=False, engine='openpyxl')

                    # status_placeholder_left.markdown(f"DataFrame successfully saved to '{diaplay_efficacy_excel_name}'")
                    status_placeholder_left.empty()

                else:
                    status_placeholder_left.markdown("Efficacy Table ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìš°ì¸¡ì˜ ì¶œë ¥ í…Œì´ë¸”ì€ ì˜¤ì§ ë…¼ë¬¸ì˜ ë³¸ë¬¸ ë‚´ìš©ì—ë§Œ ì˜ì¡´í•˜ì—¬ ìƒì„±ë©ë‹ˆë‹¤.")
                    status_placeholder_left.markdown("Organizing the table...")
                    efficacy_table_output = efficacy_table(None, related_text_input)
                    efficacy_table_output.to_excel(diaplay_efficacy_excel_name, index=False, engine='openpyxl')
                    status_placeholder_left.markdown(f"DataFrame successfully saved to '{diaplay_efficacy_excel_name}'")
                    status_placeholder_left.empty()

        
        ### Real display ...
        if 'eff_image_index' not in st.session_state:
            st.session_state.eff_image_index = 0

        if os.path.exists(diaplay_efficacy_excel_name):
            left, right = tab1.columns([1, 1])

            if len(paper_efficacy_upload) >= 2:
                current_image_file = paper_efficacy_upload[st.session_state.eff_image_index]
                current_image = Image.open(current_image_file)

                left.write("Original Table :camera:")
                left.image(current_image, caption=f"Image {st.session_state.eff_image_index + 1} of {len(paper_efficacy_upload)}")

            elif len(paper_efficacy_upload) == 1:
                current_image_file = paper_efficacy_upload[st.session_state.eff_image_index]
                current_image = Image.open(current_image_file)
                left.write("Original Table :camera:")
                left.image(current_image)

            saved_df = pd.read_excel(diaplay_replica_efficacy_excel_name, sheet_name=None)  # ëª¨ë“  ì‹œíŠ¸ ì½ê¸°
            sheet_name = list(saved_df.keys())[0]  # ì²« ë²ˆì§¸ ì‹œíŠ¸ ì´ë¦„
            saved_df[sheet_name].reset_index(inplace=True)
            right.write("Suggested Excel File :wrench:")
            edited_df = right.data_editor(saved_df[sheet_name], use_container_width=True, height=1000, num_rows = "dynamic")

            if replica_button:
                edited_df.to_excel(diaplay_replica_efficacy_excel_name, index=False, engine='openpyxl')
                status_placeholder_left.markdown(f"ë³µì œëœ í‘œëŠ” '{diaplay_replica_efficacy_excel_name}'ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìµœì¢… outputì„ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤...")

                status_placeholder_left.markdown("Organizing the table...")
                efficacy_table_output = efficacy_table(paper_pdf_upload, edited_df, related_text_input)
                efficacy_table_output.to_excel(diaplay_efficacy_excel_name, index=False, engine='openpyxl')

                status_placeholder_left.markdown(f"ìµœì¢… outputì€ '{diaplay_efficacy_excel_name}'ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
                status_placeholder_left.empty()

                saved_df = pd.read_excel(diaplay_efficacy_excel_name, sheet_name=None)  # ëª¨ë“  ì‹œíŠ¸ ì½ê¸°
                sheet_name = list(saved_df.keys())[0]  # ì²« ë²ˆì§¸ ì‹œíŠ¸ ì´ë¦„
                saved_df[sheet_name].reset_index(inplace=True)
                right.write("Suggested Excel File :wrench:")
                edited_df = right.data_editor(saved_df[sheet_name], use_container_width=True, height=1000, num_rows = "dynamic")

                unique_treat_group = saved_df[sheet_name]['treat_group'].nunique()
                unique_sub_group = saved_df[sheet_name]['sub_group'].nunique()                                 
                unique_treat_group_values = saved_df[sheet_name]['treat_group'].unique()
                unique_sub_group_values = saved_df[sheet_name]['sub_group'].unique()
                effi_total_rows = len(saved_df[sheet_name])

                right.write("Suggested Excel File :wrench:")
                edited_df = right.data_editor(saved_df[sheet_name], use_container_width=True, height=1000, num_rows = "dynamic")
                st.info(f"""
                    ğŸ“¢ **ìƒì„±ëœ ì—‘ì…€ í‘œì˜ ê°’ ìš”ì•½**ì…ë‹ˆë‹¤. ì›ë³¸ í…Œì´ë¸”ê³¼ ë¹„êµí•˜ë©° í™•ì¸í•´ ì£¼ì„¸ìš”!  

                    | í•­ëª©               | ê³ ìœ  ê°’ ê°œìˆ˜   | ê³ ìœ  ê°’ë“¤                                  |
                    |------------------|-------------|----------------------------------------|
                    | **Treat group**   | {unique_treat_group}ê°œ  | {', '.join(map(str, unique_treat_group_values))}  |
                    | **Sub group**     | {unique_sub_group}ê°œ  | {', '.join(map(str, unique_sub_group_values))}  |

                    ğŸ“Š **ì´ í–‰ì˜ ê°œìˆ˜**ëŠ” **{effi_total_rows}ê°œ**ì…ë‹ˆë‹¤.  

                    ---

                    â¡ï¸ **ë¬¸ì œê°€ ìˆë‹¤ë©´ ë‹¤ì‹œ RUN ì‹œì¼œì£¼ì„¸ìš”.**  
                    """
                )